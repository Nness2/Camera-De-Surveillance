<html>
    <head>
        <meta charset="utf-8" />
        <title>MyCamera</title>
    </head>
	<body>
		<!-- Stream video via webcam -->
		<div class="video-wrap">
			<video hidden id="video" playsinline autoplay  ></video>	
		</div>
		<!-- Webcam video snapshot -->
		<canvas id="canvas" width="640" height="480"></canvas>
		
        <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
        <script src="http://localhost:8080/socket.io/socket.io.js"></script>
		<script>
			'use strict';
			
			var socket = io.connect('http://localhost:8080');
			var name = prompt('Quel est votre nom ?');
			
			//Send name
			socket.emit('name',  name);
			var imageToSend = '';
			
			
			const video = document.getElementById('video');
			const canvas = document.getElementById('canvas');
			const errorMsgElement = document.querySelector('span#errorMsg');
			var moyBase = new Array ();
			var tolerance = 0;
			var tolerancefix = 0;
			var mouvementPic = '';
			var bool = 0;
			var BASE64_MARKER = ';base64,';
			var run = 0;
			var audio = new Audio('https://freesound.org/data/previews/470/470504_2694940-lq.mp3');
			var listMouvementFrame = new Array ();
			
			const constraints = {
				audio: false,
				video: {
					width: 640, height: 480
				}
			};
			
			
			//Send frame 
			socket.on('snapshot', function(snapshot) {
				socket.emit('frame', imageToSend);
			});
			
			socket.on('mouvement', function(mouvement) {
				socket.emit('mFrame', mouvementPic);
				tolerancefix = 0;
			});
			
			
			socket.on('alarm', function(alarm) {
				
				audio.play();
			});
			
			
			// Access webcam
			async function init() {
				try {
					const stream = await navigator.mediaDevices.getUserMedia(constraints);
					handleSuccess(stream);
				} catch (e) {
					errorMsgElement.innerHTML = `navigator.getUserMedia error:${e.toString()}`;
				}
			}
			
			//var STR = document.getElementById('canvas');


			
			//console.log(STR);
			
			
			
			// Success
			function handleSuccess(stream) {
				window.stream = stream;
				video.srcObject = stream;
			}
		
			
			// Load init
			init();
			// Draw image
			var context = canvas.getContext('2d');
			function sleep (time) {
				return new Promise((resolve) => setTimeout(resolve, time));
			}
			
			function snapshoterino(){
				//Get base64
				imageToSend = canvas.toDataURL();
				context.drawImage(video, 0, 0, 640, 480);
				var imageData = context.getImageData(0, 0, 640, 480);
				for (var i = 0, n = imageData.data.length; i < n; i += 4){
					var moy = (imageData.data[i] + imageData.data[i+1] + imageData.data[i+2]) / 3
					imageData.data[i] = moy;
					imageData.data[i + 1] = moy;
					imageData.data[i + 2] = moy;
				}
				var tab_moyenne = new Array();
				var moyenne = 0;
				for(var i = 0 ; i < 480*4 ; i=i+80){
					for(var j = 0; j < 640*4 ; j=j+80){
						for(var yp = i; yp < i+80 ; yp=yp+4){
							for(var xp = j; xp < j +80; xp=xp+4){
								
								var moyenne = moyenne + imageData.data[yp * 640 + xp];
									
						   }
						}
						tab_moyenne.push(moyenne/400);
						moyenne = 0;
					}
				}
				if (bool == 0)
					moyBase = tab_moyenne;
					
					
				if (bool == 1){
					
					for(var i = 0 ; i < moyBase.length ; i++){
						if (Math.abs((moyBase[i]) - (tab_moyenne[i])) > 10){
							console.log('mouvement');
							//listMouvementFrame.push(imageToSend);
							tolerance ++;
						}
							
					}
					if (tolerance > tolerancefix){
						tolerancefix = tolerance;
						mouvementPic = imageToSend;
						
					}
					tolerance = 0;
				}
				
				if (tab_moyenne[0] != 0) //A remplacer
					bool = 1;
				//console.log(tab_moyenne);
				context.putImageData(imageData, 0, 0);
			   
			};
			
			function update_image_comp(){
				bool = 0;
			}
			function test(){
				//socket.emit('tezst', '');
				canvas.toBlob(function(blob) {
				  var newImg = document.createElement('img'),
					  url = URL.createObjectURL(blob);

				  newImg.onload = function() {
					// no longer need to read the blob so it's revoked
					URL.revokeObjectURL(url);
				  };
				  newImg.src = url;
				  document.body.appendChild(newImg);
				  //console.log(newImg.src);
				  socket.emit('stream', newImg.src.substring(5, newImg.src.length));
			});
			}
			
			//if (run == 1){
				setInterval(snapshoterino, 250); //Compare frame toute les 0.5 sec
				setInterval(update_image_comp, 60000); //Actualise l'image de reference toute les minutes
				setInterval(test, 1000);
			//}
		</script>


	</body>


</html>